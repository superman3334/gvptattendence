<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mark Attendance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3.3.3/dist/fp.min.js"></script>
</head>
<body>
  <div class="container my-5">
    <h1 class="text-center mb-4">Mark Attendance</h1>
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card p-4">
          <h3>Scan QR Code</h3>
          <div class="mb-3">
            <label for="rollNumber" class="form-label">Roll Number</label>
            <input type="text" class="form-control" id="rollNumber" placeholder="CS101">
          </div>
          <div class="mb-3">
            <video id="video" width="100%" height="auto" style="display: none;"></video>
            <canvas id="canvas" style="display: none;"></canvas>
          </div>
          <button onclick="startScanner()" class="btn btn-primary btn-lg w-100">Start Scanner</button>
          <div id="scanResult" class="mt-3"></div>
        </div>
      </div>
    </div>
    <div class="text-center mt-4">
      <a href="/" class="btn btn-secondary">Back to Login</a>
      <a href="/check-attendance" class="btn btn-secondary">Check Attendance</a>
    </div>
  </div>

  <script>
    let stream = null;

    async function startScanner() {
      const rollNumber = document.getElementById('rollNumber').value;
      if (!rollNumber) {
        document.getElementById('scanResult').innerHTML = '<div class="alert alert-danger">Please enter roll number.</div>';
        return;
      }

      // Enhanced fingerprinting
      const fp = await FingerprintJS.load();
      const result = await fp.get({
        extendedResult: true // Include more device attributes
      });
      // Combine visitorId with additional attributes for robustness
      const fingerprint = result.visitorId + '-' + 
        navigator.userAgent + '-' + 
        window.screen.width + 'x' + window.screen.height + '-' + 
        (window.WebGLRenderingContext ? getWebGLFingerprint() : 'no-webgl');

      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');
      video.style.display = 'block';
      canvas.style.display = 'none';

      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.play();
        video.onloadedmetadata = () => {
          if (video.videoWidth === 0 || video.videoHeight === 0) {
            document.getElementById('scanResult').innerHTML = '<div class="alert alert-danger">Video feed not available. Please check your camera.</div>';
            stopScanner();
            return;
          }
          scanQRCode(rollNumber, fingerprint);
        };
      } catch (err) {
        document.getElementById('scanResult').innerHTML = '<div class="alert alert-danger">Camera access denied or unavailable.</div>';
      }
    }

    function getWebGLFingerprint() {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) return 'no-webgl';
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        return debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'no-debug-info';
      } catch (e) {
        return 'webgl-error';
      }
    }

    function scanQRCode(rollNumber, fingerprint) {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');

      function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0 && video.videoHeight > 0) {
          canvas.height = video.videoHeight;
          canvas.width = video.videoWidth;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code) {
            const qrToken = new URLSearchParams(code.data.split('?')[1]).get('token');
            submitAttendance(rollNumber, qrToken, fingerprint);
            stopScanner();
            return;
          }
        } else if (video.readyState !== video.HAVE_ENOUGH_DATA) {
          document.getElementById('scanResult').innerHTML = '<div class="alert alert-warning">Waiting for video feed to load...</div>';
        }
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    async function submitAttendance(rollNumber, qrToken, fingerprint) {
      const response = await fetch('/scan/code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rollNumber, qrToken, fingerprint })
      });
      const data = await response.json();
      document.getElementById('scanResult').innerHTML = `<div class="alert ${data.error ? 'alert-danger' : 'alert-success'}">${data.error || data.message}</div>`;
    }

    function stopScanner() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      document.getElementById('video').style.display = 'none';
    }
  </script>
</body>
</html>