<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Faculty Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="container my-5">
    <h1 class="text-center mb-4">Faculty Dashboard</h1>
    <div class="row">
      <div class="col-md-6">
        <div class="card p-4 mb-4">
          <h3>Start Attendance</h3>
          <div class="mb-3">
            <label for="year" class="form-label">Year</label>
            <select class="form-control" id="year">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Sections</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="sectionA" value="A">
              <label class="form-check-label" for="sectionA">A</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="sectionB" value="B">
              <label class="form-check-label" for="sectionB">B</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="sectionC" value="C">
              <label class="form-check-label" for="sectionC">C</label>
            </div>
          </div>
          <div class="mb-3">
            <label for="slotNumber" class="form-label">Slot Number</label>
            <select class="form-control" id="slotNumber">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
            </select>
          </div>
          <button onclick="startAttendance()" class="btn btn-primary btn-lg w-100">Start Attendance</button>
          <div id="qrCode" class="mt-3 text-center"></div>
          <div id="timer" class="mt-3"></div>
          <div id="attendedStudents" class="mt-3"></div>
          <button id="stopButton" onclick="stopSlot()" class="btn btn-danger btn-lg w-100 mt-3" style="display: none;">Stop Slot</button>
          <div id="result" class="mt-3"></div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="card p-4 mb-4">
          <h3>Manual Attendance</h3>
          <div class="mb-3">
            <label for="manualSlotId" class="form-label">Slot ID</label>
            <input type="text" class="form-control" id="manualSlotId" placeholder="Enter Slot ID">
          </div>
          <div class="mb-3">
            <label for="manualRollNumber" class="form-label">Roll Number</label>
            <input type="text" class="form-control" id="manualRollNumber" placeholder="CS101">
          </div>
          <button onclick="markManualAttendance()" class="btn btn-primary btn-lg w-100">Mark Manual Attendance</button>
          <div id="manualResult" class="mt-3"></div>
        </div>
      </div>
    </div>
  <div class="row">
    <div class="col-md-6">
      <div class="card p-4 mb-4">
        <h3>View Attendance</h3>
        <div class="mb-3">
          <label for="viewDate" class="form-label">Select Date</label>
          <input type="date" class="form-control" id="viewDate" required>
        </div>
        <div class="mb-3">
          <label for="viewYear" class="form-label">Year</label>
          <select class="form-control" id="viewYear" required>
            <option value="" disabled selected>Select Year</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="viewSection" class="form-label">Section</label>
          <select class="form-control" id="viewSection" required>
            <option value="" disabled selected>Select Section</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="viewSlotNumber" class="form-label">Slot Number</label>
          <select class="form-control" id="viewSlotNumber" required>
            <option value="" disabled selected>Select Slot</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
          </select>
        </div>
        <button onclick="fetchAttendance()" class="btn btn-primary btn-lg w-100">View Attendance</button>
        <button onclick="downloadAttendance()" class="btn btn-success btn-lg w-100 mt-2">Download as Excel</button>
        <div id="attendanceViewResult" class="mt-3"></div>
      </div>
    </div>
  </div>
    <div class="text-center">
      <a href="/" class="btn btn-secondary">Back to Login</a>
    </div>
  </div>

  <script>
    let currentSlotId = null;
    let timerInterval = null;
    const urlParams = new URLSearchParams(window.location.search);
    const facultyId = urlParams.get('facultyId');

    async function startAttendance() {
      const year = document.getElementById('year').value;
      const sections = [];
      if (document.getElementById('sectionA').checked) sections.push('A');
      if (document.getElementById('sectionB').checked) sections.push('B');
      if (document.getElementById('sectionC').checked) sections.push('C');
      const slotNumber = document.getElementById('slotNumber').value;
      if (!year || sections.length === 0 || !slotNumber) {
        document.getElementById('result').innerHTML = '<div class="alert alert-danger">Please select year, at least one section, and slot number.</div>';
        return;
      }
      try {
        const response = await fetch('/faculty/start-attendance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ year, sections, slotNumber, facultyId })
        });
        const data = await response.json();
        if (data.error) {
          document.getElementById('result').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }
        currentSlotId = data.slotId;
        document.getElementById('qrCode').innerHTML = `<img src="${data.qrCode}" alt="QR Code" style="width: 300px; height: 300px;">`;
        document.getElementById('stopButton').style.display = 'block';
        updateAttendedStudents(data.attendedStudents);
        startTimer();
        setTimeout(refreshQRCode, 15000);
        setTimeout(refreshQRCode, 30000);
        setTimeout(stopSlot, 45000);
      } catch (err) {
        document.getElementById('result').innerHTML = '<div class="alert alert-danger">Failed to start attendance. Please try again.</div>';
      }
    }

    function startTimer() {
      let timeLeft = 45;
      document.getElementById('timer').innerHTML = `Time left: ${timeLeft} seconds`;
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').innerHTML = `Time left: ${timeLeft} seconds`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          document.getElementById('timer').innerHTML = 'Slot ended';
          document.getElementById('qrCode').innerHTML = '';
          document.getElementById('stopButton').style.display = 'none';
        }
      }, 1000);
    }

    async function refreshQRCode() {
      if (!currentSlotId) return;
      try {
        const response = await fetch('/faculty/refresh-qr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slotId: currentSlotId, facultyId })
        });
        const data = await response.json();
        if (data.error) {
          document.getElementById('result').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          document.getElementById('qrCode').innerHTML = '';
          document.getElementById('stopButton').style.display = 'none';
          clearInterval(timerInterval);
          updateAttendedStudents(data.attendedStudents);
          return;
        }
        document.getElementById('qrCode').innerHTML = `<img src="${data.qrCode}" alt="QR Code" style="width: 300px; height: 300px;">`;
        updateAttendedStudents(data.attendedStudents);
      } catch (err) {
        document.getElementById('result').innerHTML = '<div class="alert alert-danger">Failed to refresh QR code.</div>';
      }
    }

    async function stopSlot() {
      if (!currentSlotId) return;
      try {
        const response = await fetch('/faculty/stop-slot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slotId: currentSlotId, facultyId })
        });
        const data = await response.json();
        document.getElementById('result').innerHTML = `<div class="alert ${data.error ? 'alert-danger' : 'alert-success'}">${data.error || data.message}</div>`;
        document.getElementById('qrCode').innerHTML = '';
        document.getElementById('stopButton').style.display = 'none';
        clearInterval(timerInterval);
        document.getElementById('timer').innerHTML = 'Slot ended';
        updateAttendedStudents(data.attendedStudents);
        currentSlotId = null;
      } catch (err) {
        document.getElementById('result').innerHTML = '<div class="alert alert-danger">Failed to stop slot.</div>';
      }
    }

    function updateAttendedStudents(attendedStudents) {
      const attendedStudentsDiv = document.getElementById('attendedStudents');
      if (attendedStudents && attendedStudents.length > 0) {
        let html = '<h4>Attended Students</h4><table class="table table-bordered"><thead><tr><th>Roll Number</th><th>Name</th><th>Section</th></tr></thead><tbody>';
        const uniqueStudents = new Set();
        attendedStudents.forEach(student => {
          const key = `${student.rollNumber}-${student.section}`;
          if (!uniqueStudents.has(key)) {
            uniqueStudents.add(key);
            html += `<tr><td>${student.rollNumber}</td><td>${student.name}</td><td>${student.section}</td></tr>`;
          }
        });
        html += `</tbody></table><button class="btn btn-success mt-3" onclick="downloadSlotAttendance('${currentSlotId}')">Download Slot Attendance</button>`;
        attendedStudentsDiv.innerHTML = html;
      } else {
        attendedStudentsDiv.innerHTML = '<p>No students attended yet.</p>';
      }
    }

    async function markManualAttendance() {
      const slotId = document.getElementById('manualSlotId').value;
      const rollNumber = document.getElementById('manualRollNumber').value;
      if (!slotId || !rollNumber) {
        document.getElementById('manualResult').innerHTML = '<div class="alert alert-danger">Please enter slot ID and roll number.</div>';
        return;
      }
      try {
        const response = await fetch('/faculty/manual-attendance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ facultyId, rollNumber, slotId })
        });
        const data = await response.json();
        document.getElementById('manualResult').innerHTML = `<div class="alert ${data.error ? 'alert-danger' : 'alert-success'}">${data.error || data.message}</div>`;
        if (!data.error && currentSlotId === slotId) {
          const slotResponse = await fetch(`/faculty/slots?facultyId=${facultyId}&slotId=${slotId}`);
          const slotData = await slotResponse.json();
          updateAttendedStudents(slotData.attendedStudents);
        }
      } catch (err) {
        document.getElementById('manualResult').innerHTML = '<div class="alert alert-danger">Failed to mark manual attendance. Please try again.</div>';
      }
    }


    async function fetchAttendance() {
      const date = document.getElementById('viewDate').value;
      const year = document.getElementById('viewYear').value;
      const section = document.getElementById('viewSection').value;
      const slotNumber = document.getElementById('viewSlotNumber').value;
      if (!date || !year || !section || !slotNumber) {
        document.getElementById('attendanceViewResult').innerHTML = '<div class="alert alert-danger">Please select date, year, section, and slot number.</div>';
        return;
      }
      try {
        const response = await fetch(`/faculty/attendance?facultyId=${facultyId}&date=${date}&year=${year}&section=${section}&slotNumber=${slotNumber}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ facultyId, year, section, slotNumber })
        });
        const data = await response.json();
        const attendanceViewResult = document.getElementById('attendanceViewResult');
        if (data.error) {
          attendanceViewResult.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }
        if (data.attendance.length === 0) {
          attendanceViewResult.innerHTML = '<p>No attendance records found for the selected date, year, section, and slot.</p>';
          return;
        }
        let html = '<h4>Attendance Records</h4><table class="table table-bordered"><thead><tr><th>Roll Number</th><th>Name</th><th>Section</th><th>Date</th><th>Slot</th></tr></thead><tbody>';
        data.attendance.forEach(record => {
          html += `<tr>
            <td>${record.rollNumber}</td>
            <td>${record.name || 'N/A'}</td>
            <td>${record.section || 'N/A'}</td>
            <td>${new Date(record.timestamp).toLocaleString()}</td>
            <td>${record.slotNumber || 'N/A'}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        attendanceViewResult.innerHTML = html;
      } catch (err) {
        document.getElementById('attendanceViewResult').innerHTML = '<div class="alert alert-danger">Failed to fetch attendance. Please check your input or try again later.</div>';
      }
    }

    async function downloadAttendance() {
      const date = document.getElementById('viewDate').value;
      const year = document.getElementById('viewYear').value;
      const section = document.getElementById('viewSection').value;
      const slotNumber = document.getElementById('viewSlotNumber').value;
      if (!date || !year || !section || !slotNumber) {
        document.getElementById('attendanceViewResult').innerHTML = '<div class="alert alert-danger">Please select date, year, section, and slot number.</div>';
        return;
      }
      window.location.href = `/faculty/download-attendance?facultyId=${facultyId}&date=${date}&year=${year}&section=${section}&slotNumber=${slotNumber}`;
    }
    async function downloadSlotAttendance(slotId) {
      window.location.href = `/faculty/download-slot-attendance?facultyId=${facultyId}&slotId=${slotId}`;
    }
  </script>
</body>
</html>